## 文件系统和sd卡

###  修订记录
| 修订说明 | 日期 | 作者 | 额外说明 |
| --- |
| 初版 | 2018/05/28 | 员清观 |  |

## 1

## 2 代码

```cpp
block.c

```
### 2.1 squashfs文件系统
**squashfs下载**<br>
  https://sourceforge.net/projects/squashfs/files/?source=navbar

```cpp
const struct squashfs_decompressor squashfs_lzo_comp_ops = {
	.init = lzo_init,	.free = lzo_free,	.decompress = lzo_uncompress,
	.id = LZO_COMPRESSION,	.name = "lzo",	.supported = 1
};

int squashfs_read_data(struct super_block *sb, void **buffer, u64 index, int length, u64 *next_index, int srclength, int pages)
  struct squashfs_sb_info *msblk = sb->s_fs_info;
  struct buffer_head **bh = kcalloc(((srclength + msblk->devblksize - 1) >> msblk->devblksize_log2) + 1, sizeof(*bh), GFP_KERNEL);
  int offset = index & ((1 << msblk->devblksize_log2) - 1);
  u64 cur_index = index >> msblk->devblksize_log2;
  if (length)
    bytes = -offset;  compressed = SQUASHFS_COMPRESSED_BLOCK(length);length = SQUASHFS_COMPRESSED_SIZE_BLOCK(length);
    for (b = 0; bytes < length; b++, cur_index++)
      bh[b] = sb_getblk(sb, cur_index); bytes += msblk->devblksize;
    ll_rw_block(READ, b, bh);
  else
    bh[0] = get_block_length(sb, &cur_index, &offset, &length); b = 1;
    bytes = msblk->devblksize - offset; compressed = SQUASHFS_COMPRESSED(length);
    length = SQUASHFS_COMPRESSED_SIZE(length);
    for (; bytes < length; b++)
      bh[b] = sb_getblk(sb, ++cur_index);      bytes += msblk->devblksize;
    ll_rw_block(READ, b - 1, bh + 1);
  if (compressed)
    |--> length = squashfs_decompress(msblk, buffer, bh, b, offset, length, srclength, pages);//return msblk->decompressor->decompress(msblk, buffer, bh, b, offset,length, srclength, pages); //int lzo_uncompress(struct squashfs_sb_info *msblk, void **buffer,	struct buffer_head **bh, int b, int offset, int length, int srclength,int pages)
      for (i = 0; i < b; i++)
        wait_on_buffer(bh[i]); avail = min(bytes, msblk->devblksize - offset);
        memcpy(buff, bh[i]->b_data + offset, avail); put_bh(bh[i]);
      res = lzo1x_decompress_safe(stream->input, (size_t)length,stream->output, &out_len);



  else ...


```

### 2.2
### 2.3
### 2.4
## 3

## 4

## 5 sd卡
工作电压范围为：2.7~3.6V； 按照卡容量分类定义：1.标准容量卡（SDSC）：最大容量为2GB 2.高容量卡（SDHC）：容量大小为2~32GB的卡 3.扩展容量卡（SDXC）：容量大小为32GB~2TB的卡； 为了区分不同的卡，SD3.0协议中在初始化和识别卡的过程中会判断用户插入的卡是SDSC/SDHC/SDXC中的哪一种卡，比如在R3中的第38Bit的CCS = 0b时，表示插入的卡为SDSC卡，而CCS = 1b时，表示插入的卡为SDHC或者SDXC卡。不同的卡在Cammand和Response中有微小的区别。

### 5.1

## 6

## cpu电源管理

###  修订记录
| 修订说明 | 日期 | 作者 | 额外说明 |
| --- |
| 初版 | 2020/04/07 | 员清观 |  |

## 平台相关改动
q3fevb的内存实在太小，有些应用无法运行起来．

## 2 valgrind
### 2.1 编译
**make menuconfig**<br>
  -> Build options ->
    build packages with debugging symbols -- gcc debug level (debug level 3)
    strip command for binaries on target (none)
    gcc optimization level (optimization level 0)
  -> Toolchain -> 这次不需要改变，只是记住，有下面两个选项也许以后会有作用．
    Toolchain path 选择使用哪一个工具链
    (-pipe) Target  () Target linker option
  -> Filesystem images -> (32xxx)size in blocks　太小，根据实际需要调整更大，或者直接设定为０．解决genext2fs错误

**/system/librtsp/librtsp.mk**<br>
需要增加-fPIC，以解决一个生成so的错误．看到了rtsp对videobox的依赖，这是非常诡异的．

**genext2fs错误**<br>
错误打印：genext2fs: couldn't allocate a block (no free space)
    错误打印中看到：buildroot/fs/ext2/ext2.mk中执行了buildroot/fs/ext2/genext2fs.sh

**最后，使用　./tools/gendisk-rootfs256m.sh 生成启动卡**
cp /home/yuan/work/m0_1s_anyiz_kernel/output/system/usr/bin/vplayer /media/yuan/4F62-8391/
valgrind --tool=memcheck --leak-check=full --show-reachable=yes --trace-children=yes　/usr/bin/videoboxd /mnt/mbox_all.json
valgrind --tool=memcheck --leak-check=full --show-reachable=yes --trace-children=yes /usr/bin/vplayer

**尝试升级3.11到3.15**<br>
根据实际下载地址修改buildroot/package/valgrind/valgrind.mk:
  https://sourceware.org/pub/valgrind/valgrind-3.15.0.tar.bz2
遇到一个编译错误，修改：code ~/work/m0_1s_anyiz_kernel/output/build/valgrind-3.15.0/VEX/priv/guest_mips_toIR.c

**x15编译问题**<br>
x15 架构选择 a9 了 所以找不到架构，去掉这个判断就可以了，在　buildroot/package/valgrind/valgrind.mk

Binary files a/package/valgrind/.valgrind.mk.swp and /dev/null differ
diff --git a/package/valgrind/valgrind.mk b/package/valgrind/valgrind.mk
index 3351561..cf5a65e 100644
--- a/package/valgrind/valgrind.mk
+++ b/package/valgrind/valgrind.mk
@@ -39,10 +39,10 @@ endif
 # not. Therefore, we adjust the host tuple to specify we're on
 # ARMv7. The valgrind package is guaranteed, through Config.in, to
 # only be selected on Cortex A8 and Cortex A9 platforms.
-ifeq ($(BR2_cortex_a8)$(BR2_cortex_a5),y)
+#ifeq ($(BR2_cortex_a8)$(BR2_cortex_a5),y)
 VALGRIND_CONF_OPT += \
        --host=$(patsubst arm-%,armv7-%,$(GNU_TARGET_NAME))
-endif
+#endif
## 3 dmalloc x86平台
**编译失败**<br>
q3f平台编译的时候，　>>>   Generating target filesystem image rootfs.cpio　出现问题：<br>
    Creating journal inode:
    Journal size too big forr filesystem.
make menuconfig -> 目标文件系统选择ext2-rev0，然后暂时问题消失，囧

pc平台编译的时候也出现错误，修改dmalloc.h文件　-> //extern char *strndup(const char *string, const DMALLOC_SIZE len);

**配置：**<br>
在 ~/.bashrc　中最后添加　function dmalloc { eval ‘command dmalloc -b $*‘; }
source  ~/.bashrc

**实现**<br>
在的源文件中添加下面的C代码： #include "dmalloc.h"
main()函数中，指定log和调试选项：　dmalloc_debug_setup("debug=0x4000503,log=/mnt/dmalloc.log");

g++ -DDMALLOC -DDMALLOC_FUNC_CHECK -o test test.cpp -L./lib -ldmallocxx
gcc -DDMALLOC -DDMALLOC_FUNC_CHECK -o test dtest.c -L./lib -ldmalloc

## 4 memwatch
## 5 mtrace
